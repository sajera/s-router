/*
 * s-router version 0.9.9 at 2016-12-27
 * @license MIT License Copyright (c) 2016 Serhii Perekhrest <allsajera@gmail.com> ( Sajera )    
 */
!function(){"use strict";function t(t){return y.indexOf(t.toUpperCase())>-1}function n(){process.env.DEBUG&&!E.empty(arguments)&&console.log.apply(console,[O].concat(Array.prototype.slice.call(arguments)))}function e(t){return b+(E.error(t)?t.stack.split("\n")[1].replace(/(.*\()|(\).*)|(.*s>)/g,""):"...")}function r(t){Object.assign.apply(Object,[this].concat(Array.prototype.slice.call(arguments,0)))}function i(t,n,e,r,i){d(E.string(r),'"ID" of Endpoint must be a string');var s=this[t];return!s[r]&&d(E.string(i),'for create endpoint "query" required and must be a string'),s[r]?s[r]:s[r]=new o(i,e,this[n],r)}function o(t,e,r,i){this.id=i,this[e]={},this.on=this.on.bind(this,e);for(var o=i.split(".").slice(0,-1),s="",a=0;a<o.length;a++){s+=r[o[a]].query;for(var c in r[o[a]][e])this.on(c,r[o[a]][e][c])}t=s+t;var u=this.params={},h=1;this.matcher=new RegExp("^"+t.replace(/\{[^}]*}\/?/gi,function(t){var n=t.replace(/[\W]/gi,""),e=t.replace(/[\w\:\/\{\}]/gi,""),r=!/\?/.test(e);u[n]=h++;var i=/\-/.test(e)?r?"":"?":n+"/"+(r?"":"?");return i+"([^\\W]+)"+(r?"":"?")+"/"})+"?$","i"),n('Endpoint "'+this.id+'" created => ',t)}function s(t,n,e,r){d(E.string(e),'"ID" of Unit must be a string');var i=this[t];return!i[e]&&d(E.string(r),'for create unit "query" required and must be a string'),i[e]?i[e]:i[e]=new a(r,n,e)}function a(t,e,r){this.id=r,this.query=t.replace(/\/+$/,""),this[e]={},this.on=this.on.bind(this,e),n('Unit "'+this.id+'" created =>',t)}function c(){Object.assign.apply(Object,[this].concat(Array.prototype.slice.call(arguments))),E.function(this.initialize)&&this.initialize()}function u(t,n,e){var r;if(!t[1].finished){if(n.length>0)try{r=n[0].apply(null,t)}catch(n){return t[2].error=n,e(t[0],t[1],t[2])}E.promise(r)?r.then(u.bind(null,t,n.slice(1),e),function(n){t[2].error=n,e(t[0],t[1],t[2])}):n.length>1&&u(t,n.slice(1),e)}}function h(t,e,r,i){var o,s=this,a=R.parse(r.url);for(var h in s[t])if(s[t][h].compare(a.pathname)){o=s[t][h];break}var p=new c({url:a,query:l.parse(a.query),options:o?o.matchParams(a.pathname):{}}),f=[r,i,p];o?(n("Handle request "+r.method+" on "+a.pathname,"Endpoint: "+o.id),u(f,[].concat(s[e].PREPROCESSOR||[]).concat(s[e][r.method]||[]).concat(o[e].PREPROCESSOR||[]).concat(o[e][r.method]||[]).concat(s.otherwise),function(t,n,r){u([t,n,r],[].concat(o[e].ERROR||[]).concat(s[e].ERROR||[]),s.crash)})):(n("otherwise request "+r.method+" on "+a.pathname),u(f,[].concat(s[e].PREPROCESSOR||[]).concat(s.otherwise),function(t,n,r){u([t,n,r],[].concat(s[e].ERROR||[]),s.crash)}))}function p(t){return d(E.string(t),'"ID" of Router must be a string'),this[t]?this[t]:this[t]=new f(t)}function f(t){this.id=t;var e=Symbol("units"),r=Symbol("endpoints"),o=Symbol("listeners");this[e]={},this[r]={},this[o]={},this.middleware=h.bind(this,r,o),this.endpoint=i.bind(this,r,e,o),this.unit=s.bind(this,e,o),this.on=this.on.bind(this,o),n('Router "'+t+'" created\n')}var l=require("querystring"),d=require("assert"),m=require("http"),R=require("url"),E=require("s-is"),y=(m.METHODS||["GET","POST","PUT","DELETE","OPTIONS","HEAD","PATCH","SEARCH","TRACE","MOVE","COPY","LOCK","UNLOCK","MKCOL","M-SEARCH","PURGE","PROPFIND","PROPPATCH","REPORT","MKACTIVITY","CONNECT","CHECKOUT","MERGE","NOTIFY","SUBSCRIBE","UNSUBSCRIBE"]).concat("PREPROCESSOR","ERROR"),O=E.platform.browser()?"s-debug:":"[0m[41m s-debug:[49m[0m",b=E.platform.browser()?"source: ":"[0m[31m source:[39m[0m ";r.prototype={constructor:r,on:function(n,e,r){var i=this[n];if(e=e.toUpperCase(),d(t(e),"Node.js "+process.version+" doesn`t support method "+e),d(E.function(r)||E.array(r),"listners must be a function or array with functions "+r),i[e]=i[e]||[],E.array(r)){for(var o=0;o<r.length;o++)d(E.function(r[o]),"listners must be a function or array with functions "+r);i[e]=i[e].concat(r)}else E.function(r)&&i[e].push(r);return this},use:function(t){return this.on("PREPROCESSOR",t)}};for(var g=0;g<y.length;g++)r.prototype[y[g].toLowerCase()]=function(t){return function(n){return this.on(t,n)}}(y[g]);o.prototype=new r({constructor:o,instance:"Endpoint",compare:function(t){return this.matcher.test(t)},matchParams:function(t){var n={},e=t.match(this.matcher);if(e)for(var r in this.params)n[r]=e[this.params[r]];return n}}),a.prototype=new r({constructor:a,instance:"Unit"}),c.prototype={constructor:c,instance:"Params",initialize:function(){n("default params initialize")}};var w=p.bind({});f.prototype=new r({constructor:f,instance:"Router",extendParams:function(t){d(E.function(t)||E._object(t),'"extend" of params must be a object or function'),E.function(t)?Object.assign(c.prototype,new t):E._object(t)&&Object.assign(c.prototype,t),n(this.id,"=> Params was extendet")},crash:function(t,r,i){n("crash report => ",e(i.error)),response.writeHead(404,{"Content-Type":"text/plain"}),response.write("404 Not Found\n"),response.end()},otherwise:function(t,e,r){n("otherwise => method not allowed"),e.writeHead(404,{"Content-Type":"text/plain"}),e.write("404 Not Found\n"),e.end()}}),E.platform.node()&&(module.exports=w)}(); 