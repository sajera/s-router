/*
 * s-routser version 0.9.91 at 2017-07-06
 * @license MIT License Copyright (c) 2016 Serhii Perekhrest <allsajera@gmail.com> ( Sajera )    
 */
!function(){"use strict";function t(t){return E.indexOf(t.toUpperCase())>-1}function n(){process.env.DEBUG&&!R.empty(arguments)&&console.log.apply(console,[y].concat(Array.prototype.slice.call(arguments)))}function e(t){return O+(R.error(t)?t.stack.split("\n")[1].replace(/(.*\()|(\).*)|(.*s>)/g,""):"...")}function r(t,n,e,r){l(R.string(e),'"ID" of Unit must be a string');var o=this[t];return!o[e]&&l(R.string(r),'for create unit "query" required and must be a string'),o[e]?o[e]:o[e]=new i(r,n,e)}function i(t,e,r){this.id=r,this.query=t.replace(/\/+$/,""),this[e]={},this.on=this.on.bind(this,e),n('Unit "'+this.id+'" created =>',t)}function o(t,n,e,r,i){l(R.string(r),'"ID" of Endpoint must be a string');var o=this[t];return!o[r]&&l(R.string(i),'for create endpoint "query" required and must be a string'),o[r]?o[r]:o[r]=new s(i,e,this[n],r)}function s(t,e,r,i){this.id=i,this[e]={},this.on=this.on.bind(this,e);for(var o=i.split(".").slice(0,-1),s="",a=0;a<o.length;a++){s+=r[o[a]].query;for(var c in r[o[a]][e])this.on(c,r[o[a]][e][c])}t=s+t;var u=this.params={},h=1;this.matcher=new RegExp("^"+t.replace(/\{[^}]*}\/?/gi,function(t){var n=t.replace(/[\W]/gi,""),e=t.replace(/[\w\:\/\{\}]/gi,""),r=!/\?/.test(e);u[n]=h++;var i=/\-/.test(e)?r?"":"?":n+"/"+(r?"":"?");return i+"([^\\W]+)"+(r?"":"?")+"/"})+"?$","i"),n('Endpoint "'+this.id+'" created => ',t)}function a(t,n,e){if(!t[1].finished){var r;if(n.length>0)try{r=n[0].apply(null,t)}catch(n){return t[2].error=n,e(t[0],t[1],t[2])}R.promise(r)?r.then(a.bind(null,t,n.slice(1),e),function(n){t[2].error=n,e(t[0],t[1],t[2])}):n.length>1&&a(t,n.slice(1),e)}}function c(t,e,r,i){var o,s=this,c=d.parse(r.url);for(var u in s[t])if(s[t][u].compare(c.pathname)){o=s[t][u];break}var h=new s.Params({url:c,query:f.parse(c.query),options:o?o.matchParams(c.pathname):{}});o?(n("Handle request "+r.method+" on "+c.pathname,"Endpoint: "+o.id),a([r,i,h],[].concat(s[e].PREPROCESSOR||[]).concat(s[e][r.method]||[]).concat(o[e].PREPROCESSOR||[]).concat(o[e][r.method]||[]).concat(s.otherwise),function(t,n,r){a([t,n,r],[].concat(o[e].ERROR||[]).concat(s[e].ERROR||[]),s.crash)})):(n("otherwise request "+r.method+" on "+c.pathname),a([r,i,h],[].concat(s[e].PREPROCESSOR||[]).concat(s.otherwise),function(t,n,r){a([t,n,r],[].concat(s[e].ERROR||[]),s.crash)}))}function u(t){return l(R.string(t),'"ID" of Router must be a string'),this[t]?this[t]:this[t]=new h(t)}function h(t){function e(){Object.assign.apply(Object,[this].concat(Array.prototype.slice.call(arguments))),R.function(this.initialize)&&this.initialize()}this.id=t;var i=Symbol("units"),s=Symbol("endpoints"),a=Symbol("listeners");this[i]={},this[s]={},this[a]={},this.Params=e,e.prototype={constructor:e,instance:"Params",initialize:function(){n("default params initialize")}},this.middleware=c.bind(this,s,a),this.endpoint=o.bind(this,s,i,a),this.unit=r.bind(this,i,a),this.on=this.on.bind(this,a),n('Router "'+t+'" created\n')}function p(t){Object.assign.apply(Object,[this].concat(Array.prototype.slice.call(arguments,0)))}var f=require("querystring"),l=require("assert"),m=require("http"),d=require("url"),R=require("s-is"),E=(m.METHODS||["GET","POST","PUT","DELETE","OPTIONS","HEAD","PATCH","SEARCH","TRACE","MOVE","COPY","LOCK","UNLOCK","MKCOL","M-SEARCH","PURGE","PROPFIND","PROPPATCH","REPORT","MKACTIVITY","CONNECT","CHECKOUT","MERGE","NOTIFY","SUBSCRIBE","UNSUBSCRIBE"]).concat("PREPROCESSOR","ERROR"),y=R.platform.browser()?"s-debug:":"[0m[41m s-debug:[49m[0m",O=R.platform.browser()?"source: ":"[0m[31m source:[39m[0m ";i.prototype=new p({constructor:i,instance:"Unit"}),R.platform.node()&&(module.exports=b),s.prototype=new p({constructor:s,instance:"Endpoint",compare:function(t){return this.matcher.test(t)},matchParams:function(t){var n={},e=t.match(this.matcher);if(e)for(var r in this.params)n[r]=e[this.params[r]];return n}});var b=u.bind({});h.prototype=new p({constructor:h,instance:"Router",extendParams:function(t){l(R.function(t)||R._object(t),'"extend" of params must be a object or function'),R.function(t)?Object.assign(this.Params.prototype,new t):R._object(t)&&Object.assign(this.Params.prototype,t),n(this.id,"=> Params was extendet")},crash:function(t,r,i){n("crash report => ",e(i.error)),r.writeHead(404,{"Content-Type":"text/plain"}),r.write("404 Not Found"),r.end()},otherwise:function(t,e,r){n("otherwise => method not allowed"),e.writeHead(404,{"Content-Type":"text/plain"}),e.write("404 Not Found"),e.end()}}),p.prototype={constructor:p,on:function(n,e,r){var i=this[n];if(e=e.toUpperCase(),l(t(e),"Node.js "+process.version+" doesn`t support method "+e),l(R.function(r)||R.array(r),"listners must be a function or array with functions "+r),i[e]=i[e]||[],R.array(r)){for(var o=0;o<r.length;o++)l(R.function(r[o]),"listners must be a function or array with functions "+r);i[e]=i[e].concat(r)}else R.function(r)&&i[e].push(r);return this},use:function(t){return this.on("PREPROCESSOR",t)}};for(var P=0;P<E.length;P++)p.prototype[E[P].toLowerCase()]=function(t){return function(n){return this.on(t,n)}}(E[P])}(); 